#!/usr/bin/env bash
set -euo pipefail

ROOT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
SIM="$ROOT_DIR/scripts/sim/lab_sim.sh"

usage() {
  cat <<'USAGE'
Usage:
  ./scripts/exp list
  ./scripts/exp run E-001
  ./scripts/exp assert E-001
  ./scripts/exp cleanup E-001
  ./scripts/exp broker <stop|start> <broker_id>
USAGE
}

list_experiments() {
  cat <<'LIST'
E-001  Outbox + Relay + processed_event success
E-002  direct-produce loss after DB commit
E-003  duplicate side-effect without processed_event
E-004  at-most-once loss via offset-first commit
E-005  retry -> DLQ -> replay recovery
E-006  schema/deploy order simulation
E-007  LSO read_committed visibility simulation
E-008  cache stampede simulation
E-009  ISR/minISR/acks matrix simulation
E-010  redis cluster slot and hashtag behavior
E-011  hot key / hot shard degradation
E-012  tx abort skip-like visibility
E-013  redis lua consistency anti-pattern
E-014  processed_event retention strategy
E-015  schema registry compatibility gate
E-018  consumer rebalance storm
E-019  mysql deadlock classification and retry
E-022  controlled backfill vs unsafe backfill
E-023  partial outage degradation
E-024  coupon issuance concurrency (redis vs mysql)
E-IAM-001  msk iam missing group permission
E-IAM-002  msk iam topic write denied
E-IAM-003  msk iam idempotent permission missing
LIST
}

run_experiment() {
  local id="$1"
  local script="$ROOT_DIR/scripts/scenarios/${id}.sh"
  [[ -x "$script" ]] || { echo "missing run script: $script" >&2; return 2; }
  "$script"
}

assert_experiment() {
  local id="$1"
  local script="$ROOT_DIR/scripts/assert/${id}.sh"
  [[ -x "$script" ]] || { echo "missing assert script: $script" >&2; return 2; }
  "$script"
}

cleanup_experiment() {
  "$SIM" reset
  echo "[OK] cleaned"
}

broker_control() {
  local action="${1:-}"
  local broker_id="${2:-1}"

  case "$action" in
    stop)
      "$ROOT_DIR/scripts/chaos/broker-stop.sh" "$broker_id"
      ;;
    start)
      "$ROOT_DIR/scripts/chaos/broker-start.sh" "$broker_id"
      ;;
    *)
      echo "usage: ./scripts/exp broker <stop|start> <broker_id>" >&2
      return 2
      ;;
  esac
}

main() {
  local cmd="${1:-}"
  local exp_id="${2:-}"

  case "$cmd" in
    list)
      list_experiments
      ;;
    run)
      [[ -n "$exp_id" ]] || { usage; exit 2; }
      run_experiment "$exp_id"
      ;;
    assert)
      [[ -n "$exp_id" ]] || { usage; exit 2; }
      assert_experiment "$exp_id"
      ;;
    cleanup)
      cleanup_experiment
      ;;
    broker)
      broker_control "${2:-}" "${3:-1}"
      ;;
    *)
      usage
      exit 2
      ;;
  esac
}

main "$@"
