# B-0313 — consumer-service: processed_event 멱등 + retry/DLQ + offset 정책 Failpoints

## Goal
At-least-once 전제에서 “중복 무해화” 및 “DLQ/Replay”를 실험 가능하게 한다.

## Topic Subscribe
- main: account.balance.v1
- retry: account.balance.retry.5s / retry.1m
- dlq: account.balance.dlq (publish target)

## Processing (정상)
DB Tx:
1) processed_event INSERT (consumer_group + dedup_key) — UNIQUE로 처리권 획득
   - 이미 있으면 SKIP(중복)
2) account_projection 업데이트(잔액 반영, version++)
3) commit
4) offset commit

## Retry/DLQ 정책
- transient(일시): timeout, deadlock, redis timeout → retry topic으로 재발행(attempt++)
- permanent(영구): schema parse, validation fail, business invariant fail → DLQ

## Failpoints
- `IDEMPOTENCY_MODE=none`:
  - processed_event 없이 projection 업데이트 → 중복 시 side-effect 2회
- `OFFSET_COMMIT_MODE=before_db`:
  - offset 먼저 커밋하고 DB 반영 전 failpoint로 종료 → 처리 유실(at-most-once) 재현
- `FORCE_PERMANENT_ERROR_ON_ACCOUNT_ID=...`:
  - 특정 이벤트를 강제로 DLQ로 보내 Replay 실험

## Deliverables
- `services/consumer-service`
- DLQ 메시지 envelope(원본 payload+meta+error)
- retry 헤더: attempt, first_seen_at

## Acceptance Criteria
- processed_event 켜면 중복이 와도 projection 결과는 1회
- IDEMPOTENCY_MODE=none이면 E-003에서 2회 반영 재현
- OFFSET_COMMIT_MODE=before_db이면 E-004에서 처리 유실 재현
