# B-0302 — docker-compose(local): Kafka(3) + Schema Registry + UI + MySQL + Redis (AWS 배포 호환 프로파일 포함)

## Goal
모든 실험을 로컬에서 돌릴 수 있도록 infra를 docker-compose로 구성하되,
추후 AWS(MSK IAM / ElastiCache / Aurora)로 옮길 때 “프로파일 스위치”만으로
동일한 애플리케이션 구성이 유지되도록 환경 계약(ENV Contract)을 고정한다.

## Why (IAM 전환 포함)
- 로컬은 PLAINTEXT로 빠르게 실험(장애 주입/재현)하고,
- AWS는 실제 운영 제약(네트워크/VPC/IAM 권한/Managed failover)을 검증한다.
- "로컬 infra"와 "AWS managed infra"를 동일 코드로 붙이려면, 공통 ENV 계약이 필요하다.

## Scope
### A) Local infra (docker-compose.local.yml)
- Kafka 3 brokers (KRaft 권장)
- Schema Registry
- Kafka UI
- MySQL 8
- Redis

### B) AWS profile 연결을 위한 compose override (docker-compose.aws.override.yml)
- 로컬에서 애플리케이션 컨테이너만 띄우고,
  Kafka/Redis/MySQL은 AWS endpoint로 연결하는 override 파일 제공
- 이 override는 infra 서비스를 disable 하거나 profile로 제외

### C) ENV Contract 고정 (모든 서비스 공통)
- LAB_PROFILE=local|aws
- Kafka
    - KAFKA_BOOTSTRAP_SERVERS
    - KAFKA_SECURITY_PROTOCOL (= PLAINTEXT | SASL_SSL)
    - KAFKA_SASL_MECHANISM (= AWS_MSK_IAM | OAUTHBEARER | empty)
    - KAFKA_SASL_JAAS_CONFIG (Java)
    - KAFKA_SASL_CALLBACK_HANDLER (Java)
    - KAFKA_CLIENT_RACK (옵션: AZ 실험)
- MySQL
    - MYSQL_URL / MYSQL_USER / MYSQL_PASSWORD
- Redis
    - REDIS_HOST / REDIS_PORT
- AWS
    - AWS_REGION
    - AWS_PROFILE (로컬 실행 시 named profile)

## Implementation Notes
- Local Kafka는 PLAINTEXT(9092)로 운영한다.
- AWS MSK IAM은 SASL_SSL + port 9098 사용이 기본이며,
  bootstrap은 AWS CLI의 BootstrapBrokerStringSaslIam를 사용한다.
- Schema Registry를 AWS로 올릴지(옵션) / 로컬에서만 사용할지 결정은 B-0356에서 다룸.

## Deliverables
- docker-compose.local.yml
- docker-compose.aws.override.yml
- infra/kafka/create-topics.sh (local)
- infra/mysql/init.sql
- infra/redis/redis.conf (필요시)
- docs/ENV_CONTRACT.md (ENV 항목/기본값/예시 정리)

## Acceptance Criteria
- local: `docker compose -f docker-compose.local.yml up -d` 후
    - Kafka UI 접속 OK
    - Schema Registry health OK
    - MySQL 접속 OK
    - Redis ping OK
- aws override: `LAB_PROFILE=aws` + override 적용 시
    - infra 컨테이너 없이도(또는 최소) 애플리케이션이 AWS endpoint로 연결 시도
    - 연결 실패 시에도 “명확한 에러 로그(bootstrap/iam/auth/policy 구분)”가 남음
