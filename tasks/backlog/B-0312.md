# B-0312 — outbox-relay: poll/lock/retry/backoff + 중복/유실 Failpoint

## Goal
Outbox → Kafka publish를 담당하는 relay를 구현하고, 중복/유실을 의도적으로 만들 수 있는 failpoint를 제공한다.

## Core Algorithm (Polling)
반복:
1) `SELECT ... FOR UPDATE SKIP LOCKED`
   - status=NEW and next_attempt_at <= now
   - LIMIT batch_size
2) status를 SENDING으로 전환
3) Kafka publish (key=account_id)
4) 성공 시 status=SENT, published_at set
5) 실패 시 attempts++, next_attempt_at=now+backoff, last_error 기록, status=NEW 또는 FAILED(영구 오류)

## Failpoints (실험용)
- `FAILPOINT_AFTER_KAFKA_SEND_BEFORE_MARK_SENT=true`
  - publish는 됐는데 outbox는 SENT로 못 바꾸고 죽음 → 재시작 시 재발행 → 중복 발생
- `FAILPOINT_BEFORE_KAFKA_SEND=true`
  - outbox는 SENDING인데 publish 전에 죽음 → 재시도 정책 검증

## Deliverables
- `services/outbox-relay`
- backoff 정책(5s, 30s, 2m...) + 최대 시도 N
- 메트릭(선택): outbox backlog, publish latency, retry count

## Acceptance Criteria
- failpoint로 중복이 100% 재현됨
- processed_event가 켜진 consumer에선 결과가 1회만 반영됨
