# B-0334 — Experiment E-011: Hot Key/Hot Shard → 지연/타임아웃 → 완화(키/샤딩/캐시)

## Goal
Redis(특히 cluster)에서 hot key/hot shard가 어떻게 장애로 이어지는지 재현하고,
키 설계/샤딩/캐시 정책으로 완화하는 성공 케이스를 만든다.

## Scenarios
### (A) 실패: hot key
- 모든 요청이 `balance:global` 같은 단일 키를 강하게 두드림
- 관측:
  - redis command latency 상승
  - query-service p99 상승
  - (파급) DB fallback이 켜져 있으면 DB 부하까지 동반 가능

### (B) 실패: hot shard (cluster)
- hash tag를 잘못 사용해 `{hot}`로 동일 슬롯에 트래픽 집중
- 특정 노드에만 부하 집중 → timeout/latency

### (C) 성공: 분산 키 전략
- 키를 `balance:{accountId}`로 분산
- 필요하면 secondary index는 DB/검색으로 분리(캐시에 몰지 않음)

### (D) 성공: stampede + hot key 동시 완화
- singleflight ON
- TTL jitter ON
- (선택) soft TTL + background refresh

## Load
- k6 시나리오 2개:
  - hot key 패턴
  - distributed key 패턴

## Deliverables
- `infra/k6/hotkey.js`, `infra/k6/distributed.js`
- `experiments/E-011-hotkey-hotshard.md`
- `scripts/assert/E-011.sh`:
  - redis exporter 지표/응답지연 비교(최소한 query-service p95 비교)
  - DB QPS 폭증 여부(스탬피드 연계 시)

## Acceptance Criteria
- 실패 케이스에서 p95/p99가 유의미하게 악화됨
- 성공 케이스에서 동일 RPS에서 악화 폭이 눈에 띄게 줄어듦
