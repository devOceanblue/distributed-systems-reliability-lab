# B-0338 — Experiment E-015: Schema Registry Compatibility로 브레이킹 변경 "사전 차단" 재현

## Goal
브레이킹 스키마 변경은 운영 장애를 만든다.
Schema Registry Compatibility 설정을 통해
"브레이킹 변경 자체가 등록/배포 단계에서 실패하도록" 차단하는 운영 표준을 실험으로 증명한다.

## Scope
### 준비
- Schema Registry가 구동 중이어야 함
- subject naming strategy를 명확히 정의:
  - 예: `{topic}-value` 또는 record name 기반
- Compatibility 모드 실험:
  - BACKWARD
  - FULL

### 시나리오
#### (A) 성공: Backward-compatible 변경 등록 성공
- v1: field `amount` (int)
- v2: optional field `memo` 추가 with default
- 기대: registry 등록 성공

#### (B) 실패: 브레이킹 변경 등록 실패
- v1: field `tags` string
- v2: field `tags` array<string> (type change)
- 기대: registry가 등록 거부(HTTP 409 등)
- 결과:
  - producer 빌드/배포 파이프라인에서 실패하도록 만들 수 있음

#### (C) 성공: 브레이킹 변경은 새 subject/topic 버전으로 우회
- `account.balance.v2` 새 토픽/subject로 등록
- consumer-first로 dual-read or upcaster 적용 후 전환

## Implementation Notes
- 실험용 스크립트:
  - `infra/schema/register.sh` (v1, v2 등록)
  - `infra/schema/set-compatibility.sh`
- CI 흉내:
  - `scripts/exp run E-015`에서 registry 등록 성공/실패를 assert

## Deliverables
- Avro schemas:
  - `contracts/avro/compat/v1.avsc`
  - `contracts/avro/compat/v2_additive.avsc`
  - `contracts/avro/compat/v2_breaking.avsc`
- scripts:
  - `infra/schema/*.sh`
- experiment doc:
  - `experiments/E-015-schema-registry-compat.md`
- Runbook.md:
  - "Compatibility 모드 선택 기준" + "브레이킹 변경 절차(v2 토픽)" 추가

## Acceptance Criteria
- BACKWARD/FULL에서 additive 변경은 성공, type change는 실패가 100% 재현
- 브레이킹 변경은 versioned topic/subject로 우회하는 성공 루트가 문서/코드로 존재
