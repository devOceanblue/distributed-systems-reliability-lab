# B-0337 — Experiment E-014: processed_event 테이블 비대화(운영 비용) + TTL/아카이빙/파티셔닝 전략 실험

## Goal
멱등을 위한 processed_event는 운영상 필수지만, 무한정 커지면:
- 인덱스/스토리지 비용 증가
- INSERT 성능 저하
- 백업/복구 비용 증가
로 이어진다.

이 티켓은 processed_event를 "재처리 가능 기간" 기준으로 관리하는
TTL/아카이빙/파티셔닝 전략을 실험하고, 성능/운영성을 비교한다.

## Scope
### 데이터 스케일 실험
- N=1,000,000 processed_event를 생성(스크립트)
- insert TPS, p95 latency 측정
- 테이블 사이즈/인덱스 크기 측정

### 전략 A: 단순 TTL 삭제 (가장 단순)
- processed_event.processed_at 기준으로
  - 30일 경과 데이터 purge
- 구현:
  - daily job (cron) 또는 mysql event scheduler
  - batched delete (LIMIT)로 락/부하 완화

### 전략 B: 아카이브 테이블로 이동
- processed_event_current / processed_event_archive 분리
- 최근 30일만 current 유지
- old rows는 archive로 이동 후 current에서 삭제

### 전략 C: 파티셔닝 (선택)
- RANGE 파티션 (processed_at by month)
- drop partition으로 purge를 O(1)에 가까운 비용으로 수행

## Experiment Design
- E-014-1: baseline(파티션/TTL 없음)에서 N 삽입 후 성능/용량 측정
- E-014-2: TTL purge 실행 시 DB 부하와 시간 측정
- E-014-3: partition drop vs delete 비교
- E-014-4: replay 기간(예: 7/30/90일)을 바꿨을 때 tradeoff 문서화

## Deliverables
- Flyway migration:
  - V2__processed_event_retention.sql (파티션/아카이브 구조 포함)
- `scripts/load/processed_event_load.sh` (더미 데이터 대량 삽입)
- `scripts/exp run E-014` + assert:
  - row count 감소/partition drop 확인
  - p95 insert latency 비교(전/후)
- `experiments/E-014-processed-event-retention.md`
- Runbook.md: "processed_event retention 운영" 절차 추가

## Acceptance Criteria
- 100만 rows 기준으로 baseline 대비 유지관리 전략의 장단점이 수치로 비교됨
- purge 작업이 서비스에 치명적 락을 유발하지 않도록 batch/partition 전략이 구현됨
- replay 가능 기간(정책)이 문서화됨
