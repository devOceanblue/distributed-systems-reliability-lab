# B-0327 — Experiment E-007: HW/LEO/LSO + read_committed 가시성(트랜잭션) (로컬 전용)

## Goal
“메시지는 존재(LEO)하지만 read_committed 컨슈머에서 안 읽히는(LSO)”
상황을 트랜잭션 프로듀서로 재현한다.

## IMPORTANT (AWS MSK IAM 제약)
- 본 실험은 Kafka 트랜잭션(Commit/Abort/Txn markers)에 의존한다.
- MSK의 IAM access control은 Kafka 내부 클러스터 액션(WriteTxnMarkers 등)을 지원하지 않아,
  트랜잭션 종료가 필요한 시나리오에 제약이 있다.
- 따라서 E-007은 **LAB_PROFILE=local (로컬 Kafka)** 에서만 수행한다.
  (AWS에서 트랜잭션 기반 실험이 필요하면 SCRAM/mTLS 트랙을 별도로 둔다)

## Setup (local)
- transactional producer 모드 토글:
    - RELAY_PRODUCER_MODE=transactional
    - consumer isolation.level=read_committed
- Failpoint:
    - FAILPOINT_AFTER_BEGIN_TX_BEFORE_COMMIT=true (트랜잭션 open 상태로 유지)

## Steps
1) 트랜잭션 시작 → 메시지 send → commit 안 하고 대기/크래시
2) Kafka에는 레코드가 존재하지만(read_uncommitted로는 보임),
   read_committed consumer는 해당 구간에서 멈춤
3) commit 또는 abort 후 consumer가 다시 진행됨 확인

## Deliverables
- experiments/E-007-lso-visibility.md
- scripts/exp E-007
- scripts/assert/E-007.sh (가능하면 lag/처리 정체 확인)

## Acceptance Criteria
- read_uncommitted에서는 보이는데 read_committed에서는 멈추는 현상이 100% 재현
- 문서에 HW/LEO/LSO 관계가 “운영 관점”으로 설명됨
