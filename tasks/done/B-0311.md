# B-0311 — command-service: 도메인 변경 + Outbox 기록 (정상) / direct-produce(실패 모드)

## Goal
정상(Outbox)과 실패(direct-produce) 두 경로를 모두 제공하여 “유실/중복” 실험을 가능하게 한다.

## Endpoints
- POST /accounts/{id}/deposit
  - body: { "txId": "...", "amount": 1000 }
- POST /accounts/{id}/withdraw

## 정상 경로 (DEFAULT)
DB Tx 안에서:
1) account balance 업데이트
2) ledger insert (tx_id unique)
3) outbox_event insert (dedup_key=tx_id)

## 실패 경로 (TOGGLE)
환경변수 `PRODUCE_MODE=direct` 일 때:
- DB commit 후 Kafka publish(Outbox 미사용)
- Failpoint: DB commit 후 publish 직전 `FAILPOINT_AFTER_DB_COMMIT_BEFORE_KAFKA_SEND=true` → 프로세스 종료
  - 기대: DB는 반영되었지만 Kafka 이벤트 유실

## Deliverables
- `services/command-service` Spring Boot 앱
- 공통 event-core 사용(Avro)
- Failpoint 구현(환경변수 기반)

## Acceptance Criteria
- Outbox 모드에서 request 1건당 outbox_event 1행 생성
- direct 모드 + failpoint에서 “유실”이 재현되고 실험 스크립트가 검증함
