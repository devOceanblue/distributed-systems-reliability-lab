# B-0314 — query-service: Redis cache-aside + TTL/jitter + invalidation + stampede 방어

## Goal
Redis 캐시의 “성능/정확성 트레이드오프”를 성공/실패로 실험한다.

## Read Path (기본)
- GET /accounts/{id}/balance
  1) redis GET cacheKey
  2) miss면 DB(account_projection) 조회
  3) redis SETEX(TTL+jitter)

## Invalidation (정상)
- consumer-service가 projection 업데이트 후:
  - `CACHE_INVALIDATION_MODE=DEL`: 해당 key DEL
  - `CACHE_INVALIDATION_MODE=VERSIONED`: version INCR 후 새 key로 조회 유도

## Fail Modes
- `CACHE_INVALIDATION_MODE=NONE` + 긴 TTL:
  - stale cache 재현(E-006/E-008 일부)
- `STAMPEDE_PROTECTION=OFF`:
  - TTL 동시 만료 시 DB QPS 폭증(E-008)

## Stampede 방어(정상)
- singleflight:
  - redis lock `lock:{key}` SET NX PX
  - lock 보유자만 DB 조회/캐시 업데이트
  - 나머지는 짧게 wait + 재조회 또는 stale serve(옵션)
- soft TTL(선택):
  - 만료 직전이면 background refresh

## Deliverables
- `services/query-service`
- config(ENV): TTL_SECONDS, TTL_JITTER_SECONDS, STAMPEDE_PROTECTION
- 부하 테스트와 함께 동작 검증(E-008)

## Acceptance Criteria
- invalidation OFF일 때 stale이 확실히 재현됨
- singleflight ON일 때 DB 부하가 유의미하게 줄어듦(스크립트로 수치 비교)
