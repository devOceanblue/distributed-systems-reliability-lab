# B-0323 — Experiment E-003: ❌ processed_event 없이 중복 메시지로 side-effect 2회

## Goal
relay 재발행(중복)을 만들고, processed_event가 없으면 side-effect(잔액/집계)가 2번 반영되는 장애를 재현한다.

## Setup
- PRODUCE_MODE=outbox
- outbox-relay failpoint:
  - FAILPOINT_AFTER_KAFKA_SEND_BEFORE_MARK_SENT=true (publish 후 죽어서 중복 재발행 유도)
- consumer: IDEMPOTENCY_MODE=none

## Steps
1) deposit 1건(tx1, +1000)
2) relay가 publish 후 죽음 → 재시작 → 동일 outbox 재발행
3) consumer가 2번 처리
4) assert:
   - ledger는 1건
   - projection balance는 2000(잘못)
   - processed_event가 없으니 중복 차단 불가

## Fix Variant
- IDEMPOTENCY_MODE=processed_table로 다시 실행하면 projection balance=1000이 되어야 함

## Deliverables
- `experiments/E-003-duplicate.md`
- `scripts/assert/E-003.sh`
