# B-0324 — Experiment E-004: ❌ offset 선커밋(at-most-once)로 처리 유실

## Goal
offset commit을 DB 반영보다 먼저 해버리면, 크래시 시 메시지가 “처리되지 않았는데도 재처리되지 않는” 유실이 발생함을 재현한다.

## Setup
- consumer: OFFSET_COMMIT_MODE=before_db
- consumer failpoint: FAILPOINT_AFTER_OFFSET_COMMIT_BEFORE_DB_COMMIT=true

## Steps
1) deposit 10건 발행
2) consumer가 offset commit 후 죽음
3) 재시작해도 이미 offset이 진행되어 재처리 안 됨
4) assert:
   - Kafka에는 메시지가 존재했으나 projection 반영 수 < 10
   - processed_event도 부족
   - 유실 발생

## Fix Variant
- OFFSET_COMMIT_MODE=after_db 로 변경하면 유실이 없어야 함(중복은 processed_event가 흡수)

## Deliverables
- `experiments/E-004-at-most-once-loss.md`
- `scripts/assert/E-004.sh`
