# B-0341 — Experiment E-018: Consumer Rebalance 폭탄 재현 (max.poll.interval/긴 처리/GC) + 완화 전략 검증

## Goal
실무에서 흔한 장애: consumer 처리 시간이 길어지거나 GC/IO로 멈추면
- max.poll.interval.ms 위반 → consumer가 group에서 쫓겨남
- re-balance 반복 → 처리 지연/lag 폭증
- at-least-once 특성상 중복 처리 가능성 증가
를 유발한다.

이 실험은:
1) 리밸런스를 "의도적으로" 만들고
2) 중복/지연/lag 악화를 관측하며
3) 설정/처리 전략(튜닝, 배치 크기, pause/resume, retry 설계)으로 완화
까지 증명한다.

---

## Background (핵심 개념)
- consumer는 poll을 주기적으로 호출해야 한다.
- max.poll.interval.ms 내에 다음 poll이 오지 않으면 "죽었다"고 보고 파티션을 회수하고 리밸런스 발생.
- heartbeat는 별도 스레드로 보내지만, "poll 루프가 너무 오래 멈추면" 결국 max.poll.interval 위반으로 탈락.
- 리밸런스 자체는 정상 동작이지만 빈번하면:
  - lag 급증
  - 처리 throughput 감소
  - 중복 처리(미커밋 offset) 확률 증가

---

## Scope
### 1) consumer-service에 "처리 지연 failpoint" 추가
- ENV:
  - PROCESSING_DELAY_MS=0 (기본)
  - FAILPOINT_DELAY_ON_EVENT_TYPE=AccountBalanceChanged (선택)
- 처리 로직(레코드 처리 중)에서 delay를 주입:
  - Thread.sleep(PROCESSING_DELAY_MS)

### 2) consumer 설정 토글
- Case FAIL(리밸런스 유발):
  - max.poll.interval.ms=3000 (3초)
  - max.poll.records=500 (큰 배치)
  - PROCESSING_DELAY_MS=20 (500*20ms=10초) -> poll 지연
- Case SUCCESS(완화):
  - max.poll.interval.ms=60000
  - max.poll.records=50 (배치 축소)
  - 또는 processing을 분할 처리 + periodic poll/commit
  - (선택) consumer pause/resume + 작업 큐(비권장 모드도 실험 가능)

### 3) 관측 지표/로그
- consumer 리밸런스 로그(Assigned/Revoke)
- consumer lag(가능하면 Grafana/Prometheus)
- 처리율(records/sec)
- processed_event dedup skip count (중복이 얼마나 발생했는지)

---

## Experiment Steps
### E-018-A (Failure) — Rebalance 폭탄 재현
1) Setup
- relay/producer로 이벤트 대량 생성(예: 10k)
- consumer:
  - max.poll.interval.ms=3000
  - max.poll.records=500
  - PROCESSING_DELAY_MS=20
  - IDEMPOTENCY_MODE=processed_table (중복은 무해화되게 하되, dedup 스킵률 관측)

2) Run
- consumer 실행 후 1~2분 관측

3) Assert (정량 기대)
- 리밸런스 로그가 반복 발생(예: 10회 이상)
- consumer lag이 급격히 증가 또는 소거 속도 급감
- dedup skip count가 의미있게 증가(중복 재처리 발생 신호)
- p95/p99 latency 상승(선택: query-service 또는 consumer 처리 지연)

### E-018-B (Success) — 튜닝으로 완화
1) consumer 설정 변경
- max.poll.interval.ms=60000
- max.poll.records=50
- PROCESSING_DELAY_MS 유지(또는 낮춤)하되, "탈락하지 않게" 구성

2) Run 동일 부하
3) Assert
- 리밸런스 횟수 대폭 감소(0~1 수준)
- lag 소거 속도 개선
- dedup skip rate 감소
- outbox backlog/age가 정상 범위로 회복

---

## Deliverables
- consumer-service:
  - processing delay failpoint 구현
  - 설정을 ENV로 주입 가능하게
  - 리밸런스 이벤트 로그를 명확히 남기기(assigned/revoked)
- experiment doc:
  - `experiments/E-018-rebalance-storm.md`
- scripts:
  - `scripts/exp run E-018`
  - `scripts/assert/E-018.sh`:
    - 리밸런스 로그 카운트(간단 grep)
    - lag 또는 처리 카운트 비교(가능한 범위)
    - dedup skip 증가 확인
- Runbook:
  - "리밸런스 폭탄 대응 체크리스트" 추가

---

## Acceptance Criteria
- Failure 구성에서 리밸런스 폭탄이 100% 재현된다.
- Success 구성에서 동일 부하에서 리밸런스/lag 악화가 유의미하게 완화된다.
- dedup(Processed Event)가 중복의 비즈니스 영향을 막는다는 것이 수치로 드러난다.
